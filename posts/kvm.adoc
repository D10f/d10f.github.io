= Better Virtual Machines With KVM/QEMU
D10f <devontheroof@pm.me>
v1, 2024-06-11
:license-url: https://creativecommons.org/licenses/by-sa/4.0/
:license-title: CC BY-SA 4.0
:doctype: article
:description: ...
:keywords: virtualization linux kernel virtual-machines
:technologies: shell qemu
:source-highlighter: pygments
:icons: font
:toc:

https://wiki.libvirt.org/VM_lifecycle.html[General Concepts]

This post focuses on working with the CLI utilities that exist around `libvirt` and `qemu` to manage virtual machines.

== Hardware Virtualization Support

Check if hardware supports virtualization by running `lscpu | grep -i virtualization:`. If it comes back empty-handed, it means that your hardware does not support virtualization (possibly because is not enabled, check your BIOS settings). For AMD CPUs this should return with "AMD-V", whereas for Intel it would be "VT-X".

Once it's confirmed that it indeed supports it, you can check whether the appropriate kernel modules are loaded or not, by running: `sudo modinfo kvm`. The command `zgrep CONFIG_KVM /boot/config-$(uname -r)` will list the current configuration of the KVM module; a value of `y` indicating that it's always available or `m` for available for install/uninstall.

== Installation

We are going to need the following packages; these are the installation commands and a brief summary of what they do:

For Debian:

[source,console]
----
$ sudo apt install qemu-kvm libvirt-daemon-system virtinst virt-manager virt-viewer bridge-utils
----

For RedHat:

[source,console]
----
$ sudo dnf install qemu-system-x86 libvirt-daemon-system virtinst virt-manager virt-viewer ovmf swtpm qemu-utils guestfs-tools libosinfo-bin tuned
----

qemu-kvm:: Bridges the gap between hardware emulation, provided by QEMU, and the kernel-based hypervisor provided by KVM. Automatically detects and installs the appropriate package for the underlying CPU architecture e.g., qemu-system-x86-64.

qemu-utils:: Provides qemu-img (disk image utility), qemu-io (disk exerciser), qemu-nbd (network block device).

libvirt-daemon-system:: Contains the configuration files to run the libvirt daemon as a system service.

libvirt-clients:: Provides command line utility "virsh" to interact with libvirt.

virtinst:: Provides command line utilities to create and edit virtual machines.

virt-manager:: Desktop application interface to manage virtual machines through libvirt. Includes an embedded VNC and Spice client viewer for access to graphical console of virtual machines.

virt-viewer:: Displays the graphical console of a virtual machine.

ovmf:: Open Virtual Machine Firmware, allows use of UEFI on virtual machines.

swtpm:: TPM emulator.

guestfs-tools:: Contains the guestfish interactive shell and various virtualization tools.

libosinfo-bin:: Contains the runtime files to detect operating systems and query the osinfo database via libosinfo.

tuned:: Daemon for monitoring and adaptive tuning of system devices.

bridge-utils:: Utilities for configuring the Linux Ethernet bridge, this makes virtual machines visible to one another and the host.

=== Windows OS guests

If you want to run virtual machines with Windows OS you also need virtio drivers, which for lack of official released drivers by Microsoft are provided by the Virtio-win ISO.

For RedHat based, start by adding the repository and install it:

[source,console]
----
# sudo wget https://fedorapeople.org/groups/virt/virtio-win/virtio-win.repo -O /etc/yum.repos.d/virtio-win.repo
----

[source,console]
----
# sudo dnf install virtio-win
----

By default, this provides the stable version of the driver. For the most up-to-date version edit this repository configuration file and set `enabled=1` in the `virtio-win-latest` stanza. This package will install an ISO file under `/usr/share/virtio-win/`.

For non-RedHat distributions https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/[there is a direct download website]. To install the drivers the ISO needs to be mounted to the virtual machine as a CD-ROM and use it to install the necessary drivers.

== Creating A New Guest

To create a new domain you can use the `virsh-install` command, followed by a description of the characteristics of the virtual machine, such as RAM, CPU cores, etc.

NOTE: The libvirt documentation often refers to virtual machines as "domains" or "guest domains". For the purposes of this post, I'll use terms like "domain", "guest", "instance" and "virtual machine" interchangeably.

We can create a new virtual machine "from scratch", that is, using a regular ISO file just like we would run a new installation on hardware, or from a preexisting image file.

=== From ISO File

The main difference with other methods is that we need an ISO file to point to when running the virtual machine for the first time. This is equivalent as using an external media device (CD-ROM, USB drive, etc.) plugged in to the computer.

[source,console]
----
$ virsh-install \
    --virt-type kvm \ # <1>
    --name debian12 \ # <2>
    --disk path=/var/lib/libvirt/images/debian12.qcow2,size=15 \ # <3>
    --graphics spice \ # <4>
    --vcpu 1 \ # <5>
    --memory 4096 \ # <6>
    --cdrom $HOME/Downloads/debian12.iso \ # <7>
    --network bridge=virbr0 \ # <8>
    --osinfo debian12 \ # <9>
----
<1> Type of virtualization technology. Other options include "qemu", "lxc" and "xen".
<2> Given name for this particular guest instance.
<3> The location where to store the image for this virtual machine, and the size. This can be resized later.
<4> Type of remote graphics viewer. Can be "spice" or "vnc".
<5> Number if cores to assign to this virtual machine.
<6> Amount of memory to assign to this virtual machine.
<7> The location of the ISO file to use to start the virtual machine. This is only needed the first time to install the operating system.
<8> Network interface to bind to. The "virbr0" interface is created by default.
<9> Type of the operating system. Run the command `virt-install --osinfo list` to see all the available options for this field.

TIP: To store ISO files in restricted directories you can use Access Control Lists (ACL) to grant users access to them. Run the command `setfacl -m u:${USER}:rwX /var/lib/libvirt/images` to grant your user access to this directory.

=== From An Existing Image

//=== From Remote Resources

//== Snapshots

//=== Creating Snapshots

//=== Creating Images

== Sharing Files Between Host And Guest With Virtiofs

To enable sharing of files, edit the XML configuration file for that virtual machine. You can do this from the command line or using the GUI through `virt-manager`.

=== From The Command Line


From the command line you can use the `virsh edit` command followed by the domain name you want to edit. This will open that domain's XML configuration file in your preferred terminal-based editor, as defined by the `$EDITOR` variable. Add the following lines to the configuration:

[source,xml]
----
<domain>
    ...
    <memoryBacking>
        <source type='memfd'/>
        <access mode='shared'/>
    </memoryBacking>
    <devices>
        ...
        <filesystem type='mount' accessmode='passthrough'>
            <driver type='virtiofs' queue='1024'/>
            <source dir='/home/user/Public'/> # <1>
            <target dir='host_public_files'/> # <2>
        </filesystem>
    </devices>
</domain>
----
<1> The path on the host that should be available to the guest.
<2> An arbitrary tag to reference from within the guest to complete the mount.

With these changes, you can now mount this drive by running this command from within the guest:

[source,console]
----
$ sudo mount -t virtiofs host_public_files /mnt/public_files
----

Using the appropriate values for the mount tag and whatever location you want to mount to.

=== From Virt Manager

Using the graphical `virt-manager` the steps are largely the same: edit the XML configuration file. To access it, first select the domain you want to edit and enable the option found at Edit -> Preferences -> Enable XML Editing. Then, click on the "Open" button to launch the viewer and switch the view mode: View -> Details.

image::virt-manager-virtiofs.png[]

From here is a matter of writing the XML sections described above. Head over to the "Memory" section to add the _memoryBacking_. For the file system, click on the "Add Hardware button" -> File system and fill in the details at the prompt; you can also edit it manually using the XML tab.

NOTE: The "Export file system as read only mount" option is not supported by `virtiofs` as of the writing of this post.

== Managing Domains

IMPORTANT: There are hundreds of commands that the `virsh` utility provides to managing KVM domains. This is a non-comprehensive list of some of the ones that I most commonly use.

=== Inspecting Domains

To check on existing domains run the `virsh list` command. By default, it will only show _active_ domains, that is, running instances. Use options like `--all` or `--with-snapshot` to filter the output; options like `--uuid` or `--title` will also display specific details about the domains.

Use `virsh dominfo` to inspect a domain more closely to show information such as resources allocated to this domain.

[source,console]
----
$ virsh dominfo debian12
----

[literal]
Id:             -
Name:           debian12
UUID:           733a9603-bec1-4929-9cb4-580848003000
OS Type:        hvm
State:          shut off
CPU(s):         2
Max memory:     4194304 KiB
Used memory:    4194304 KiB
Persistent:     yes
Autostart:      disable
Managed save:   no
Security model: apparmor
Security DOI:   0

=== Start, Shutdown, Reboot and Destroy

The `start` and `reboot` sub-commands are quite self-explanatory. As for `shutdown` and `destroy`, the difference is that the latter is akin to pulling the power cord on a physical machine, without giving it any chance to terminate gracefully.

=== Suspend And Resume

Another way of halting a virtual machine without shutting it down is to use `virsh suspend`. In this state, it will show up as "paused" when doing a listing with `virsh list` and it will continue to consume allocated resources by the host OS, such as RAM and CPU cores. However, it won't be eligible for scheduling by the hypervisor, meaning no activity resulting from disk and network I/O. To bring it back up use `virsh resume`.

=== Save And Restore

To shut down the machine entirely while retaining the current state you can use the `virsh save` command. This is very similar to suspend except that the resources allocated to the domain are freed, and the state of the machine is saved into a _state file_, which can then be referenced by the `virsh restore` command. +
This is akin to hibernating a physical machine but without accounting for disk state. For a more comprehensive and fully-featured way of preserving the state of a domain, see Snapshots.

=== Remove Domains

To completely remove a domain use the `virsh undefine` command. By itself, it will remove the configuration file only but all snapshots and storage volumes will persist.

== Edit Domain Configuration Files

Once a domain has been created we can change some of its parameters using various `virsh` sub-commands, such as `virsh domrename` to change the given name.

== Managing Networks

By default, `libvirt` will create a virtual interface `virbr0` that all domains can connect to. You can check this with the `ip` command and check for this interface (it will also show the IP address assigned) or with `virsh net-list` command:

[source,console]
----
$ virsh net-list
----

[literal]
 Name      State    Autostart   Persistent
--------------------------------------------
 default   active   yes         yes

Networks are defined as XML files, for example, the default one can be found at `/usr/share/libvirt/networks/default.xml`. Once this file exists you can _define_ a new interface using it as a configuration source by running `virsh net-define <path/to/xml>`. If you ever delete this default interface accidentally, you can use this to reestablish the network.
